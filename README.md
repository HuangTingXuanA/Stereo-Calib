# 双目相机标定系统

基于圆形标定板的双目相机标定系统，使用椭圆检测算法提取亚像素级圆心坐标。

## 特性

- **椭圆检测**: 使用高精度椭圆检测算法提取圆心
- **指纹匹配**: 通过几何指纹自动识别大圆位置，解决旋转不变性问题
- **缺失圆推算**: 支持部分圆缺失的情况，通过单应性矩阵推算缺失圆的位置
- **两种使用模式**: 
  - 配置文件模式：自定义大圆位置
  - 默认模式：使用四角+中心的默认大圆布局

## 编译

```bash
mkdir build
cd build
cmake ..
cmake --build . -j12
```

## 使用方法

### 模式1：使用配置文件（推荐）

```bash
./build/stereo_calibrator calibration_board.yaml ./images
```

配置文件格式（`calibration_board.yaml`）：

```yaml
%YAML:1.0
---
board:
   rows: 9
   cols: 11
   circle_spacing: 60.0

anchor_circles:
   - row: 2
     col: 5
     x: 300.0
     y: 120.0
     z: 0.0
   - row: 4
     col: 2
     x: 120.0
     y: 240.0
     z: 0.0
   - row: 4
     col: 8
     x: 480.0
     y: 240.0
     z: 0.0
   - row: 6
     col: 5
     x: 300.0
     y: 360.0
     z: 0.0
   - row: 6
     col: 6
     x: 360.0
     y: 360.0
     z: 0.0
```

**注意**：
- 文件必须以 `%YAML:1.0` 开头
- 必须配置恰好 5 个大圆（anchor_circles）
- 世界坐标 (x, y, z) 单位为毫米

### 模式2：使用默认大圆布局

```bash
./build/stereo_calibrator ./images 9 11 60.0
```

参数说明：
- `./images`: 图像目录（包含 /left 和 /right 子文件夹）
- `9`: 标定板行数
- `11`: 标定板列数
- `60.0`: 圆心间距（毫米）

默认大圆位置：四角 + 中心

## 图像目录结构

```
images/
├── left/
│   ├── image_0.bmp
│   ├── image_1.bmp
│   └── ...
└── right/
    ├── image_0.bmp
    ├── image_1.bmp
    └── ...
```

支持的图像格式：`.jpg`, `.jpeg`, `.png`, `.bmp`, `.tiff`, `.tif`

## 输出文件

- `calibration.yaml`: 标定结果（相机内参、畸变系数、双目外参）
- `points_3d.txt`: 标定板圆心的3D坐标

## 算法流程

1. **加载图像**: 从 left 和 right 目录读取图像对
2. **椭圆检测**: 使用椭圆检测算法提取所有圆
3. **大圆识别**: 提取5个最大的圆作为大圆
4. **指纹匹配**: 计算几何指纹并匹配到配置中的大圆
5. **单应性计算**: 根据大圆位置计算单应性矩阵
6. **圆心推算**: 推算所有圆（包括缺失的小圆）的位置
7. **圆心匹配**: 将检测到的小圆与推算位置匹配
8. **双目标定**: 使用张正友标定法计算相机参数

## 技术细节

### 指纹匹配

通过计算5个大圆两两之间的距离构建几何指纹矩阵（5x5），该指纹具有旋转不变性和尺度不变性。通过枚举所有排列（120种）找到最佳匹配。

### 缺失圆处理

即使部分小圆未被检测到，系统仍能通过单应性矩阵推算其位置。例如：
- 检测到：5个大圆 + 70个小圆
- 推算：24个缺失的小圆
- 最终：99个完整的圆心用于标定

### 串行处理

为便于调试，所有处理均为串行执行，不使用多线程。

## 依赖

- OpenCV 4.x
- C++17
- CMake 3.16+

## 作者

双目相机标定系统
